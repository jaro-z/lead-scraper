<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chorizo Lead Scraper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            chorizo: {
              DEFAULT: '#DC4A4A',
              hover: '#C43E3E',
            },
            cream: '#F9F5F3',
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-title">
        <img src="logo.png" alt="Chorizo" class="chorizo-logo">
        <h1>Lead Scraper</h1>
      </div>
      <div id="api-usage" class="api-usage">Loading...</div>
    </header>

    <!-- Dashboard View -->
    <div id="dashboard-view">
      <div class="actions-bar">
        <button id="new-search-btn" class="btn btn-primary">+ New Search</button>
      </div>

      <div id="searches-list" class="searches-list">
        <p class="empty-state">No searches yet. Click "New Search" to get started.</p>
      </div>
    </div>

    <!-- Results View -->
    <div id="results-view" class="hidden">
      <div class="results-header">
        <button id="back-btn" class="btn btn-secondary">&larr; Back</button>
        <div class="search-info">
          <h2 id="search-title">Results</h2>
          <span id="search-meta" class="meta"></span>
        </div>
      </div>

      <!-- Unified Toolbar -->
      <div class="unified-toolbar" id="pipeline-progress">
        <div class="stage-pills">
          <button class="stage-pill active" data-stage="raw">Raw <span id="stat-raw">0</span></button>
          <button class="stage-pill" data-stage="enriched">Enriched <span id="stat-enriched">0</span></button>
          <button class="stage-pill" data-stage="qualified">Qualified <span id="stat-qualified">0</span></button>
          <button class="stage-pill" data-stage="ready">Ready <span id="stat-ready">0</span></button>
        </div>

        <div class="toolbar-search">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="search-filter" placeholder="Search..." class="search-input-compact">
        </div>

        <div class="custom-select" id="segment-filter-wrapper">
          <button class="custom-select-trigger" id="segment-filter-btn">
            <span id="segment-filter-text">All</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </button>
          <div class="custom-select-dropdown hidden" id="segment-filter-dropdown">
            <button class="custom-select-option selected" data-value="">All</button>
            <button class="custom-select-option" data-value="saas">SaaS</button>
            <button class="custom-select-option" data-value="agency">Agency</button>
            <button class="custom-select-option" data-value="e-commerce">E-commerce</button>
            <button class="custom-select-option" data-value="manufacturing">Manufacturing</button>
            <button class="custom-select-option" data-value="services">Services</button>
            <button class="custom-select-option" data-value="other">Other</button>
          </div>
          <input type="hidden" id="segment-filter" value="">
        </div>

        <!-- Action buttons -->
        <button id="dedupe-btn" class="btn btn-secondary btn-small" title="Check for duplicates">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 12l2 2 4-4"/>
            <circle cx="12" cy="12" r="10"/>
          </svg>
          Dedupe
        </button>

        <button id="push-notion-btn" class="btn btn-secondary btn-small" disabled title="Select leads first">
          <img src="notion-logo.png" alt="" width="14" height="14">
          Push to Notion <span id="notion-count"></span>
        </button>

        <div class="toolbar-more">
          <button class="btn-more" id="more-menu-btn">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
            </svg>
          </button>
          <div class="more-dropdown hidden" id="more-dropdown">
            <button id="export-btn" class="dropdown-item">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"/>
              </svg>
              Export CSV
            </button>
            <button id="delete-selected-btn" class="dropdown-item danger hidden">Delete Selected</button>
          </div>
        </div>

        <button id="main-action-btn" class="btn btn-main-action" disabled title="Select leads first">
          <span id="main-action-text">Select leads to enrich</span>
        </button>
      </div>

      <div id="results-table-container">
        <table id="results-table">
          <thead>
            <tr>
              <th class="checkbox-col"><input type="checkbox" id="select-all"></th>
              <th class="sortable" data-sort="name">Name</th>
              <th class="sortable" data-sort="address">City</th>
              <th class="sortable" data-sort="website">Website</th>
              <th class="sortable" data-sort="segment">Segment</th>
              <th class="status-col">Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="results-body">
          </tbody>
        </table>
      </div>

      <div id="results-count" class="results-count"></div>
    </div>

    <!-- Hidden elements for backwards compatibility -->
    <input type="checkbox" id="website-filter" class="hidden">
    <select id="stage-filter" class="hidden"><option value=""></option></select>

    <!-- New Search Modal -->
    <div id="search-modal" class="modal hidden">
      <div class="modal-content">
        <h2>New Search</h2>
        <form id="search-form">
          <div class="form-group">
            <label for="query">Search Term</label>
            <input type="text" id="query" placeholder="e.g., marketing agencies" required>
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" placeholder="e.g., Prague or Czechia" required>
          </div>
          <div class="form-group">
            <label for="grid-size">Grid Size</label>
            <select id="grid-size">
              <option value="small">Small (2x2 = 4 cells)</option>
              <option value="medium" selected>Medium (3x3 = 9 cells)</option>
              <option value="large">Large (5x5 = 25 cells)</option>
            </select>
            <p class="hint">More cells = more results but more API calls</p>
          </div>
          <div class="form-actions">
            <button type="button" id="cancel-search" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Start Search</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="modal hidden">
      <div class="modal-content progress-content">
        <h2>Searching...</h2>
        <div id="progress-status" class="progress-status">Initializing...</div>
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
        <div id="progress-details" class="progress-details"></div>
      </div>
    </div>

    <!-- AI Enrich Panel -->
    <div id="enrich-panel" class="enrich-panel hidden">
      <div class="enrich-panel-header">
        <div class="enrich-panel-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="enrich-panel-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z" />
          </svg>
          <span>AI Enrichment</span>
        </div>
        <button id="close-enrich-panel" class="enrich-close-btn">&times;</button>
      </div>

      <div class="enrich-panel-summary">
        <div class="enrich-overall-progress">
          <span id="enrich-progress-text">0 of 0 companies</span>
          <div class="enrich-progress-bar">
            <div id="enrich-progress-fill" class="enrich-progress-fill"></div>
          </div>
        </div>
      </div>

      <div class="enrich-panel-current">
        <div class="enrich-current-company">
          <span class="enrich-current-label">Currently processing:</span>
          <span id="enrich-current-name" class="enrich-current-name">-</span>
        </div>

        <div class="enrich-steps">
          <div class="enrich-step" data-step="scrape">
            <div class="enrich-step-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
              </svg>
            </div>
            <div class="enrich-step-content">
              <span class="enrich-step-name">Scrape website</span>
              <span class="enrich-step-status"></span>
            </div>
            <div class="enrich-step-indicator"></div>
          </div>

          <div class="enrich-step" data-step="analyze">
            <div class="enrich-step-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09Z" />
              </svg>
            </div>
            <div class="enrich-step-content">
              <span class="enrich-step-name">AI analysis</span>
              <span class="enrich-step-status"></span>
            </div>
            <div class="enrich-step-indicator"></div>
          </div>

          <div class="enrich-step" data-step="contacts">
            <div class="enrich-step-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
              </svg>
            </div>
            <div class="enrich-step-content">
              <span class="enrich-step-name">Find contacts</span>
              <span class="enrich-step-status"></span>
            </div>
            <div class="enrich-step-indicator"></div>
          </div>

          <div class="enrich-step" data-step="validate">
            <div class="enrich-step-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
            </div>
            <div class="enrich-step-content">
              <span class="enrich-step-name">Validate emails</span>
              <span class="enrich-step-status"></span>
            </div>
            <div class="enrich-step-indicator"></div>
          </div>

          <div class="enrich-step" data-step="hunter">
            <div class="enrich-step-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
              </svg>
            </div>
            <div class="enrich-step-content">
              <span class="enrich-step-name">Hunter fallback</span>
              <span class="enrich-step-status"></span>
            </div>
            <div class="enrich-step-indicator"></div>
          </div>
        </div>
      </div>

      <div id="enrich-results" class="enrich-results">
        <div class="enrich-results-header">Results</div>
        <div id="enrich-results-list" class="enrich-results-list"></div>
      </div>
    </div>

    <!-- Dedupe Panel (Notion) -->
    <div id="dedupe-panel" class="dedupe-panel hidden">
      <div class="dedupe-panel-header">
        <div class="dedupe-panel-title">
          <img src="notion-logo.png" alt="Notion" class="notion-logo-small">
          <span>De-duplicate vs Notion CRM</span>
        </div>
        <button id="close-dedupe-panel" class="dedupe-close-btn">&times;</button>
      </div>

      <div id="dedupe-not-configured" class="dedupe-not-configured hidden">
        <div class="config-warning">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
          </svg>
          <p>Notion not configured. Add these to your <code>.env.local</code>:</p>
          <pre>NOTION_API_KEY=secret_xxx
NOTION_DATABASE_ID=your_database_id</pre>
        </div>
      </div>

      <div id="dedupe-loading" class="dedupe-loading hidden">
        <div class="spinner"></div>
        <p>Fetching contacts from Notion CRM...</p>
      </div>

      <div id="dedupe-results" class="hidden">
        <div class="dedupe-summary">
          <div class="dedupe-stat unique">
            <span class="dedupe-stat-value" id="dedupe-unique-count">0</span>
            <span class="dedupe-stat-label">Unique</span>
          </div>
          <div class="dedupe-stat dupes">
            <span class="dedupe-stat-value" id="dedupe-dupe-count">0</span>
            <span class="dedupe-stat-label">Duplicates</span>
          </div>
          <div class="dedupe-stat total">
            <span class="dedupe-stat-value" id="dedupe-total-count">0</span>
            <span class="dedupe-stat-label">Total checked</span>
          </div>
        </div>

        <div class="dedupe-actions">
          <button id="dedupe-delete-dupes" class="btn btn-danger btn-small">Delete Duplicates</button>
          <button id="dedupe-export-unique" class="btn btn-primary btn-small">Export Unique to Notion</button>
        </div>

        <div class="dedupe-list-header">
          <span>Review duplicates (click to expand)</span>
        </div>
        <div id="dedupe-list" class="dedupe-list"></div>
      </div>
    </div>

    <!-- Dedupe backdrop -->
    <div id="dedupe-backdrop" class="dedupe-backdrop hidden"></div>

    <!-- Full View Panel -->
    <div id="full-view-panel" class="side-panel hidden">
      <div class="panel-header">
        <h3>Company Details</h3>
        <button id="close-panel" class="btn btn-small">&times;</button>
      </div>
      <div id="panel-content" class="panel-content"></div>
    </div>
  </div>

  <!-- Enrich backdrop -->
  <div id="enrich-backdrop" class="enrich-backdrop hidden"></div>

  <!-- Stage Context Menu -->
  <div id="stage-context-menu" class="context-menu hidden">
    <div class="context-menu-header">Move to Stage</div>
    <button class="context-menu-item" data-stage="raw">
      <span class="stage-dot raw"></span> Raw
    </button>
    <button class="context-menu-item" data-stage="enriched">
      <span class="stage-dot enriched"></span> Enriched
    </button>
    <button class="context-menu-item" data-stage="qualified">
      <span class="stage-dot qualified"></span> Qualified
    </button>
    <button class="context-menu-item" data-stage="ready">
      <span class="stage-dot ready"></span> Ready
    </button>
  </div>

  <script src="app.js"></script>
</body>
</html>
